<!DOCTYPE html>
<html>
    <head>
        <title>Multi User Interaction</title>
        <script src="js/aframe.min.js"></script>
        <script src="js/aframe-environment-component.min.js"></script>
        
        <script src="https://unpkg.com/aframe-event-set-component@4.2.1/dist/aframe-event-set-component.min.js"></script>
        <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.misc.min.js"></script>
        <script src="https://unpkg.com/super-hands@^3.0.3/dist/super-hands.min.js"></script>

        <script src="js/pickup.js"></script>
        <script src="js/mole.js"></script>
    </head>
    <body>

       <a href="/wack.html">
            <button id="btn" style="position: absolute; z-index:9999;">Testing Button</button> 
        </a>
        
        <a-scene>
            <!--camera-->
            <a-camera curpos id="camera" camera-listener wasd-controls look-controls position="0 1.6 0">
                <a-entity cursor="rayOrigin:mouse;" raycaster="far:20; interval:200; objects:.interactive;"></a-entity>
                <a-box></a-box>
            </a-camera>

            <a-entity environment="preset:default;"></a-entity>
            
            <a-box holdable class="interactive" id="testCube" position="3 0.5 3" width="1" depth="1" height="1"></a-box>

            <!--Mole Model -->
            <a-entity position="0 0 0" class="">
                <a-entity class="interactive" position="1 0 0" id="mole">
                    <a-cylinder id="mBody"  position="0 0 0"           color="#63421b" height="1" radius="0.25" class="interactive"></a-cylinder>
                    <a-sphere   id="mHead"  position="0 0.5 0"         color="#63421b" radius="0.25" class="interactive"></a-sphere>
                    <a-cone     id="mSnout" position="0 0.35 0.27"     color="#DAA06D" rotation="90 0 0" radius-bottom="0.15" height="0.25" class="interactive"></a-cone> 
                    <a-sphere   id="mEyeL"  position="-0.16 0.4 0.172" color="black"  radius="0.05" class="interactive"></a-sphere>
                    <a-sphere   id="mEyeR"  position="0.16 0.4 0.172"  color="black"  radius="0.05" class="interactive"></a-sphere>
                    <a-sphere   id="mNose"  position="0 0.352 0.398"   color="black"  radius="0.025" class="interactive"></a-sphere>
                </a-entity>
                <a-entity class="interactive" position="0 0 0" id="mole">
                    <a-cylinder id="mBody"  position="0 0 0"           color="#63421b" height="1" radius="0.25" class="interactive"></a-cylinder>
                    <a-sphere   id="mHead"  position="0 0.5 0"         color="#63421b" radius="0.25" class="interactive"></a-sphere>
                    <a-cone     id="mSnout" position="0 0.35 0.27"     color="#DAA06D" rotation="90 0 0" radius-bottom="0.15" height="0.25" class="interactive"></a-cone> 
                    <a-sphere   id="mEyeL"  position="-0.16 0.4 0.172" color="black"  radius="0.05" class="interactive"></a-sphere>
                    <a-sphere   id="mEyeR"  position="0.16 0.4 0.172"  color="black"  radius="0.05" class="interactive"></a-sphere>
                    <a-sphere   id="mNose"  position="0 0.352 0.398"   color="black"  radius="0.025" class="interactive"></a-sphere>
                </a-entity>
                <a-entity class="interactive" position="-1 0 0" id="mole">
                    <a-cylinder id="mBody"  position="0 0 0"           color="#63421b" height="1" radius="0.25" class="interactive"></a-cylinder>
                    <a-sphere   id="mHead"  position="0 0.5 0"         color="#63421b" radius="0.25" class="interactive"></a-sphere>
                    <a-cone     id="mSnout" position="0 0.35 0.27"     color="#DAA06D" rotation="90 0 0" radius-bottom="0.15" height="0.25" class="interactive"></a-cone> 
                    <a-sphere   id="mEyeL"  position="-0.16 0.4 0.172" color="black"  radius="0.05" class="interactive"></a-sphere>
                    <a-sphere   id="mEyeR"  position="0.16 0.4 0.172"  color="black"  radius="0.05" class="interactive"></a-sphere>
                    <a-sphere   id="mNose"  position="0 0.352 0.398"   color="black"  radius="0.025" class="interactive"></a-sphere>
                </a-entity>
            </a-entity>
            

            <!-- Cork Model -->
            <a-cone holdable class="interactive" position="0 0.5 1" color="#DAA06D" rotation="0 0 0" radius-bottom="0.15" radius-top="0.25" height="0.5"></a-cone> 

            <!--Place holder for moles-->
            <a-entity position="5 0 0" id="moles">
                <a-cylinder id="0" moleanim class="interactive" position="0 -0.5 0" height="1" radius="0.25" color="#5C4033"></a-cylinder>
                <a-cylinder id="1" moleanim class="interactive" position="1 -0.5 0" height="1" radius="0.25" color="#5C4033"></a-cylinder>
                <a-cylinder id="2" moleanim class="interactive" position="-1 -0.5 0" height="1" radius="0.25" color="#5C4033"></a-cylinder>
            </a-entity>
            
            <!--<a-cylinder class="interactive" position="0 -0.5 0" height="1" radius="0.25" color="#5C4033"
                            animation__click="property:position.y; to:-0.5; from:0.5; startEvents:click; dur:300;"
                            animation__pop="property:position.y; to:0.5; from:-0.5; startEvents:popping; dur:300;"></a-cylinder>-->

            <!--transparent box? -->
            <!--<a-box position="-1 1 -1" material="transperent:true; opacity:0;"></a-box>-->

            <script src="/socket.io/socket.io.js"></script>
            <script>
                
                let socket = io();

                socket.on('connect', (userData)=> {

                    console.log(socket.id);

                    /*
                    AFRAME.registerComponent('curpos', {
                        init:function(){
                            let rot = this.el.getAttribute('rotation');
                            let pos = this.el.getAttribute('position');
                            socket.emit('updatePlayer', [pos, rot, socket.id]);
                            console.log('hello');
                        }
                    });*/

                    setInterval(function(){
                        let camera = document.getElementById('camera');
                        
                        let rot = camera.getAttribute('rotation');
                        let pos = camera.getAttribute('position');
                        socket.emit('updatePlayer', [pos, rot, socket.id]);
                    }, 100);

                    //test with button
                    btn.addEventListener('click', function(){
                        socket.emit('btnClick');
                    });

                    //updates player location
                    socket.on('updatePlayer', (data)=>{
                        let player = document.getElementById(data[2]);

                        //if player exisits then update it's location
                        if(player){
                            player.setAttribute('position', data[0]);
                            player.setAttribute('rotation', data[1]);
                        }
                        
                    });

                    //creates players when they join
                    socket.on('joined', (data)=>{
                        console.log('someone joined');
                        
                        let scene = document.querySelector("a-scene");

                        let player = document.createElement('a-box');
                        player.setAttribute('color', 'green');
                        player.setAttribute('position', {x:0, y:1, z: 1});
                        player.setAttribute('rotation', {x:0, y:0, z: 0});
                        player.setAttribute('id', data);

                        scene.append(player);

                        socket.emit('drawExisting', [data, socket.id]);
                    });

                    //draws exisiting players
                    socket.on('existing', (data)=>{
                        let scene = document.querySelector("a-scene");

                        let player = document.createElement('a-box');
                        player.setAttribute('color', 'blue');
                        player.setAttribute('position', {x:0, y:1, z: 3});
                        player.setAttribute('rotation', {x:0, y:0, z: 0});
                        player.setAttribute('id', data);

                        scene.append(player);
                    });

                    //adding change events
                    for(i=0; i < moles.length; i++){
                        moles[i].addEventListener('click', function(){
                            socket.emit('mHit', this.id);
                        });
                    }

                    //not needed anymore
                    socket.on('posChange', (data)=> {
                        let cube = document.getElementById("testCube");
                        cube.setAttribute("position", {x: data.x, y:data.y, z:data.z});
                        console.log('changed position');

                    });

                    //server determines which mole to have pop up
                    socket.on('molePop', (data)=>{
                        
                        for(let i = 0; i < data.length; i++){
                            let mole = moles[data[i]];
                            mole.emit('rising', null, false);
                        }

                        //add chance of cork

                    });

                    //when a mole is clicked or missed
                    socket.on('moleDrop', (data)=>{
                        let mole = moles[data];
                        mole.emit('fall', null, false);
                    });

                });

            </script>

        </a-scene>
    </body>
</html>